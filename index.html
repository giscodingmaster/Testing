<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gas CRN Tracker - Live Database</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #00796B; --secondary-color: #FFC107; --danger-color: #D32F2F;
            --light-bg: #F4F6F8; --white-bg: #FFFFFF; --dark-text: #333333;
            --muted-text: #6c757d; --border-color: #e0e0e0; --font-family: 'Poppins', sans-serif;
            --pending-color: #ff9800;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--light-bg); color: var(--dark-text); font-family: var(--font-family); line-height: 1.6; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: var(--white-bg); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.04); padding: 25px; margin-bottom: 25px; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; font-size: 16px; font-weight: 500; text-align: center; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; text-decoration: none; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: var(--dark-text); }
        .btn-outline { background-color: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-sm { padding: 8px 16px; font-size: 14px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; margin-bottom: 30px; position: relative; }
        .sync-status { font-size: 14px; color: var(--muted-text); display: flex; align-items: center; gap: 8px; position: absolute; left: 0; }
        .sync-status .fa-spin { color: var(--primary-color); }
        .sync-status.offline .fa-cloud { color: var(--danger-color); }
        .sync-status.synced .fa-cloud-check { color: var(--primary-color); }
        .header-content { text-align: center; flex-grow: 1; }
        .header h1 { font-size: 36px; font-weight: 600; color: var(--dark-text); margin-bottom: 10px; }
        .header-content p { font-size: 18px; color: var(--muted-text); }
        .back-btn, .logout-btn { background: #fff; border: 1px solid var(--border-color); color: var(--muted-text); border-radius: 8px; height: 40px; padding: 0 15px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .back-btn:hover, .logout-btn:hover { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .page { display: none; } .page.active { display: block; }
        .crn-item { border: 1px solid var(--border-color); border-radius: 10px; padding: 20px; margin-bottom: 15px; background-color: #fdfdfd; transition: all 0.2s ease-out; position: relative; }
        .crn-item.pending-sync::after { content: '⏳ قيد المزامنة'; position: absolute; top: 10px; left: 10px; background: var(--pending-color); color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 500; }
        .crn-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .crn-id { font-weight: 600; font-size: 20px; color: var(--primary-color); }
        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 500; border: 1px solid; }
        .status-unknown { background-color: #fff8e1; border-color: #ffe082; color: #795548;}
        .status-site { background-color: #ede7f6; border-color: #d1c4e9; color: #4527a0;}
        .status-field { background-color: #e3f2fd; border-color: #90caf9; color: #0d47a1; }
        .status-map { background-color: #e8f5e9; border-color: #a5d6a7; color: #1b5e20; }
        .status-danger { background-color: #ffebee; border-color: #ef9a9a; color: #c62828; }
        .crn-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .detail-item .detail-label { font-size: 13px; color: var(--muted-text); margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: flex-end; }
        .action-btn { flex: 1 1 180px; }
        .filter-section { background-color: var(--white-bg); border-radius: 12px; padding: 20px; margin-bottom: 25px; border-top: 4px solid var(--primary-color); }
        .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .filter-title { font-size: 20px; font-weight: 600; color: var(--dark-text); flex-grow: 1; }
        .filter-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .filter-select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 16px; background-color: var(--light-bg); appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: left 0.75rem center; background-size: 16px 12px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--light-bg); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .results-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 15px; background: var(--white-bg); border-radius: 12px; border: 1px solid var(--border-color); }
        .results-count { font-size: 16px; font-weight: 500; color: var(--primary-color); }
        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 20px 0; }
        .pagination-btn { padding: 8px 16px; border: 1px solid var(--border-color); background: var(--white-bg); color: var(--dark-text); border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .search-box { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 16px; background-color: var(--light-bg); margin-bottom: 15px; }
        .table-container { overflow-x: auto; }
        #buildings-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #buildings-table th, #buildings-table td { padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); }
        #buildings-table th { background-color: var(--light-bg); font-weight: 600; }
        #buildings-table tr:hover { background-color: #f8f9fa; }
        .completed-row { background-color: #e8f5e9 !important; }
        .issue-row { background-color: #ffebee !important; }
        .button-group-ux { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
        .data-management-buttons { display: flex; flex-direction: row; justify-content: center; gap: 15px; flex-wrap: wrap;}
        .btn-ux { display: flex; align-items: center; justify-content: flex-start; padding: 20px 25px; font-size: 18px; border-radius: 12px; text-align: right; }
        .btn-ux-icon { margin-left: 15px; }
        .btn-ux-text { flex-grow: 1; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background-color: #fff; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--border-color); }
        .stat-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; margin: 0 auto 15px; }
        .stat-value { font-size: 28px; font-weight: 600; color: var(--dark-text); }
        .stat-label { font-size: 14px; color: var(--muted-text); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; overflow-y: auto; padding: 20px; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; text-align: center; }
        .modal-content h3 { margin-bottom: 20px; }
        .modal-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 16px; margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .preview-summary { text-align: right; margin-bottom: 20px; }
        .preview-summary p { margin: 5px 0; font-size: 16px; }
        .preview-summary .success { color: #28a745; }
        .preview-summary .warning { color: #ffc107; }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay"><div class="loader"></div></div>
    
    <div class="container" style="display: none;">
        <!-- Home Page (for Office/Field users) -->
        <div id="home-page" class="page">
            <div class="header">
                <div class="sync-status" id="sync-status"><i class="fas fa-cloud"></i> <span>جاري التحقق...</span></div>
                <div><button class="logout-btn"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button></div>
                <div class="header-content"><h1><i class="fas fa-fire"></i> Gas CRN Tracker</h1><p>نظام متابعة وتأكيد توصيل الغاز الطبيعي للمباني</p></div>
                <div style="width:110px"></div>
            </div>
            <div class="card">
                <h2 style="text-align: center; margin-bottom: 25px; font-weight: 600;">اختر واجهة المستخدم</h2>
                <!-- FIX: Removed the count badge from buttons -->
                <div class="button-group-ux">
                    <button id="office-btn" class="btn btn-primary btn-ux" onclick="showPage('main-page', 'office')"><span class="btn-ux-icon"><i class="fas fa-building"></i></span><span class="btn-ux-text">المطلوب من المكتب</span></button>
                    <button id="field-btn" class="btn btn-secondary btn-ux" onclick="showPage('main-page', 'field')"><span class="btn-ux-icon"><i class="fas fa-hard-hat"></i></span><span class="btn-ux-text">المطلوب من الموقع</span></button>
                </div>
            </div>
        </div>
        
        <!-- Main Task Page (for Office/Field users) -->
        <div id="main-page" class="page">
             <div class="header">
                 <div class="sync-status" id="main-sync-status"><i class="fas fa-cloud"></i> <span>جاري التحقق...</span></div>
                 <button class="back-btn" onclick="showPage('home-page')"><i class="fas fa-arrow-right"></i> العودة</button><div class="header-content"><h1 id="user-type-label">مهام المستخدم</h1></div><div style="width: 100px;"></div></div>
            <div class="filter-section">
                <div class="filter-header">
                    <div class="filter-title"><i class="fas fa-filter"></i> تصفية المباني</div>
                    <div class="filter-actions"><button class="btn btn-sm btn-primary" onclick="exportCurrentView()"><i class="fas fa-file-excel"></i> تصدير</button></div>
                </div>
                <input type="text" id="search-box" class="search-box" placeholder="بحث بـ CRN أو اسم المحافظة أو المدينة..." oninput="debounceSearch()">
                <div class="filter-controls">
                    <div class="filter-group"><label class="filter-label">المحافظة</label><select id="governorate-filter" class="filter-select" onchange="updateCityFilter()"><option value="">جميع المحافظات</option></select></div>
                    <div class="filter-group"><label class="filter-label">المدينة</label><select id="city-filter" class="filter-select" onchange="updateSectorFilter()"><option value="">جميع المدن</option></select></div>
                    <div class="filter-group"><label class="filter-label">القطاع</label><select id="sector-filter" class="filter-select" onchange="updateBlockFilter()"><option value="">جميع القطاعات</option></select></div>
                    <div class="filter-group"><label class="filter-label">البلوك</label><select id="block-filter" class="filter-select" onchange="renderCRNList()"><option value="">جميع البلوكات</option></select></div>
                    <div class="filter-group"><label class="filter-label">نتائج لكل صفحة</label><select id="page-size" class="filter-select" onchange="changePageSize()"><option value="20">20</option><option value="50" selected>50</option><option value="100">100</option><option value="all">الكل</option></select></div>
                </div>
            </div>
            
            <div class="results-info">
                <div class="results-count" id="results-count">عدد النتائج: 0</div>
                <div class="pagination-controls">
                    <button class="pagination-btn" id="prev-btn" onclick="previousPage()" disabled><i class="fas fa-chevron-right"></i></button>
                    <span id="page-info">صفحة 1 من 1</span>
                    <button class="pagination-btn" id="next-btn" onclick="nextPage()" disabled><i class="fas fa-chevron-left"></i></button>
                </div>
            </div>
            <div id="crn-list"><div class="card" style="text-align:center; color: var(--muted-text);">لا توجد مهام حالياً.</div></div>
        </div>
        
        <!-- ADMIN Dashboard Page -->
        <div id="dashboard-page" class="page">
            <div class="header">
                <div><button class="logout-btn"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button></div>
                <div class="header-content"><h1><i class="fas fa-chart-pie"></i> لوحة تحكم المدير</h1></div>
                <div style="width: 100px;"></div>
            </div>
            <div class="card">
                <h2 style="text-align: center; margin-bottom: 15px; font-weight: 600;">إدارة البيانات</h2>
                <div class="data-management-buttons">
                    <label for="add-file-input" class="btn btn-primary"><i class="fas fa-plus"></i> إضافة بيانات جديدة</label>
                    <input type="file" id="add-file-input" onchange="handleNewDataUpload(event)" accept=".xlsx, .xls" style="display: none;">
                    <label for="update-file-input" class="btn btn-secondary"><i class="fas fa-edit"></i> تحديث الحالة من ملف</label>
                    <input type="file" id="update-file-input" onchange="handleStatusUpdateUpload(event)" accept=".xlsx, .xls" style="display: none;">
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-icon" style="background-color: #e8f5e9; color: #1b5e20;"><i class="fas fa-check-double"></i></div><div class="stat-value" id="stat-completed">0</div><div class="stat-label">مهام مكتملة</div></div>
                <div class="stat-card"><div class="stat-icon" style="background-color: #e3f2fd; color: #0d47a1;"><i class="fas fa-shipping-fast"></i></div><div class="stat-value" id="stat-at-field">0</div><div class="stat-label">قيد التنفيذ في الموقع</div></div>
                <div class="stat-card"><div class="stat-icon" style="background-color: #fff8e1; color: #795548;"><i class="fas fa-hourglass-half"></i></div><div class="stat-value" id="stat-at-office">0</div><div class="stat-label">قيد التنفيذ في المكتب</div></div>
                <div class="stat-card"><div class="stat-icon" style="background-color: #fbe9e7; color: #bf360c;"><i class="fas fa-building"></i></div><div class="stat-value" id="stat-total">0</div><div class="stat-label">إجمالي المباني</div></div>
            </div>

            <div class="filter-section">
                <div class="filter-header">
                    <div class="filter-title"><i class="fas fa-cogs"></i> لوحة التحكم المفصلة</div>
                    <div class="filter-actions">
                        <button class="btn btn-sm btn-primary" onclick="exportCurrentView()"><i class="fas fa-file-excel"></i> تصدير</button>
                        <button class="btn btn-sm btn-outline" onclick="resetDashboardFilters()"><i class="fas fa-sync-alt"></i> إعادة تعيين</button>
                        <button class="btn btn-sm btn-danger" onclick="handleDeleteFilteredData()"><i class="fas fa-trash"></i> حذف المحدد</button>
                    </div>
                </div>
                <input type="text" id="dashboard-search" class="search-box" placeholder="بحث بـ CRN أو اسم المحافظة أو المدينة..." oninput="debounceDashboardSearch()">
                <div class="filter-controls">
                    <div class="filter-group"><label class="filter-label">المحافظة</label><select id="dashboard-governorate" class="filter-select" onchange="updateDashboardCityFilter()"><option value="">جميع المحافظات</option></select></div>
                    <div class="filter-group"><label class="filter-label">المدينة</label><select id="dashboard-city" class="filter-select" onchange="updateDashboardSectorFilter()"><option value="">جميع المدن</option></select></div>
                    <div class="filter-group"><label class="filter-label">القطاع</label><select id="dashboard-sector" class="filter-select" onchange="updateDashboardBlockFilter()"><option value="">جميع القطاعات</option></select></div>
                    <div class="filter-group"><label class="filter-label">البلوك</label><select id="dashboard-block" class="filter-select" onchange="renderDashboard()"><option value="">جميع البلوكات</option></select></div>
                    <div class="filter-group"><label class="filter-label">الحالة</label>
                        <select id="dashboard-status-filter" class="filter-select" onchange="renderDashboard()">
                            <option value="">جميع الحالات</option>
                            <option value="needs-office-action">تحتاج إجراء مكتبي</option>
                            <option value="needs-field-visit">تحتاج زيارة ميدانية</option>
                            <option value="field-confirmed">تم تأكيد الموقع</option>
                            <option value="map-confirmed">مكتمل</option>
                            <option value="site-issue-reported">تم الإبلاغ عن مشكلة</option>
                        </select>
                    </div>
                    <div class="filter-group"><label class="filter-label">نتائج لكل صفحة</label><select id="dashboard-page-size" class="filter-select" onchange="changeDashboardPageSize()"><option value="50">50</option><option value="100" selected>100</option><option value="200">200</option><option value="all">الكل</option></select></div>
                </div>
            </div>
            
            <div class="results-info">
                <div class="results-count" id="dashboard-results-count">عدد النتائج: 0</div>
                <div class="pagination-controls">
                    <button class="pagination-btn" id="dashboard-prev-btn" onclick="previousDashboardPage()" disabled><i class="fas fa-chevron-right"></i></button>
                    <span id="dashboard-page-info">صفحة 1 من 1</span>
                    <button class="pagination-btn" id="dashboard-next-btn" onclick="nextDashboardPage()" disabled><i class="fas fa-chevron-left"></i></button>
                </div>
            </div>
            
            <div class="card">
                <div class="table-container"><table id="buildings-table"><thead><tr><th>CRN</th><th>المحافظة</th><th>المدينة</th><th>القطاع</th><th>البلوك</th><th>الحالة</th><th>إجراءات</th></tr></thead><tbody></tbody></table><div id="dashboard-no-data" style="display:none; text-align:center; padding: 40px; color: var(--muted-text);"><i class="fas fa-table fa-3x" style="margin-bottom: 15px;"></i><h3>لا توجد بيانات للعرض</h3><p>جرب تغيير معايير التصفية أو قم باستيراد ملف بيانات جديد.</p></div></div>
            </div>
        </div>
        <div class="footer" style="text-align: center; margin-top: 40px; color: var(--muted-text); font-size: 14px;">Gas CRN Tracker &copy; 2024</div>
    </div>
    
    <div id="details-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <h3>إضافة تفاصيل المشكلة</h3>
            <p style="color: var(--muted-text); margin-bottom: 20px;">الرجاء وصف المشكلة التي واجهتها في الموقع. هذا سيغلق المهمة بشكل نهائي.</p>
            <textarea id="problem-details-input" class="modal-input" placeholder="اكتب التفاصيل هنا..." rows="4" style="height: auto;"></textarea>
            <input type="hidden" id="modal-db-key-input">
            <div class="modal-actions">
                <button class="btn btn-danger" onclick="submitProblemDetails()">تأكيد وإغلاق المهمة</button>
                <button class="btn btn-outline" onclick="closeDetailsModal()">إلغاء</button>
            </div>
        </div>
    </div>
    
    <div id="update-preview-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>مراجعة تحديثات الحالة</h3>
            <div id="update-preview-summary" class="preview-summary"></div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="confirmUpdates()"><i class="fas fa-check"></i> تأكيد التحديث</button>
                <button class="btn btn-outline" onclick="closeUpdatePreviewModal()"><i class="fas fa-times"></i> إلغاء</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, onValue, update, push, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCPcXicM19QkmAyHELSGcGCV57zrFvHH4Y",
            authDomain: "testing-6d021.firebaseapp.com",
            databaseURL: "https://testing-6d021-default-rtdb.firebaseio.com",
            projectId: "testing-6d021",
            storageBucket: "testing-6d021.firebasestorage.app",
            messagingSenderId: "534942328377",
            appId:"1:534942328377:web:70079093f1a6cd67568fe8",
            measurementId: "G-4W4HVQ5046"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        
        let currentUserRole = 'user';
        
        onAuthStateChanged(auth, user => {
            const loadingOverlay = document.getElementById('loading-overlay');
            const mainContainer = document.querySelector('.container');
            if (user) {
                get(ref(database, 'users/' + user.uid)).then((snapshot) => {
                    currentUserRole = snapshot.exists() ? snapshot.val() : 'user';
                    loadingOverlay.style.display = 'none';
                    mainContainer.style.display = 'block';
                    configureUIForRole(currentUserRole);
                    loadInitialData();
                    initializeOfflineSync();
                });
            } else {
                window.location.href = 'login.html'; 
            }
        });

        function configureUIForRole(role) {
            document.querySelectorAll('.logout-btn').forEach(btn => btn.onclick = () => signOut(auth));
            if (role === 'admin') showPage('dashboard-page');
            else {
                showPage('home-page');
                const officeBtn = document.getElementById('office-btn'), fieldBtn = document.getElementById('field-btn');
                officeBtn.style.display = (role === 'office' || role === 'admin') ? 'flex' : 'none';
                fieldBtn.style.display = (role === 'field' || role === 'admin') ? 'flex' : 'none';
                
                if (role !== 'office' && role !== 'field' && role !== 'admin') { 
                    const homeCard = document.querySelector('#home-page .card');
                    if(homeCard) homeCard.innerHTML = `<h2 style="text-align:center;">ليس لديك دور محدد.</h2><p style="text-align:center;">يرجى التواصل مع المدير.</p>`;
                }
            }
        }
        
        let isSyncing = false;
        const OFFLINE_QUEUE_KEY = 'gas-crn-offline-queue';

        function getOfflineQueue() {
            return JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || '[]');
        }

        function saveOfflineQueue(queue) {
            localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(queue));
        }

        async function syncQueuedUpdates() {
            if (isSyncing || !navigator.onLine) {
                updateSyncStatusUI();
                return;
            }
            let queue = getOfflineQueue();
            if (queue.length === 0) {
                updateSyncStatusUI(true);
                return;
            }

            isSyncing = true;
            updateSyncStatusUI();

            const updatesToSync = { ...queue[0].data };
            const itemDbKey = queue[0].db_key;
            
            try {
                await update(ref(database), updatesToSync);
                queue.shift(); 
                saveOfflineQueue(queue);
                console.log(`Successfully synced batch ${itemDbKey}.`);
            } catch (error) {
                console.error(`Sync failed for batch ${itemDbKey}:`, error);
            } finally {
                isSyncing = false;
                if (queue.length > 0) {
                    setTimeout(syncQueuedUpdates, 1000); 
                } else {
                    updateSyncStatusUI(true);
                }
            }
        }
        
        function queueUpdate(db_key, updateData) {
            let queue = getOfflineQueue();
            const updates = {};
            updates[`/buildings/${db_key}`] = updateData;
            
            queue.push({ db_key: db_key + '_' + Date.now(), data: updates });
            saveOfflineQueue(queue);
            
            const buildingIndex = buildingsData.findIndex(b => b.db_key === db_key);
            if(buildingIndex > -1) {
                Object.assign(buildingsData[buildingIndex], updateData);
                refreshAllViews();
            }
            
            syncQueuedUpdates();
        }

        function updateSyncStatusUI(isSynced = false) {
            const statusElements = document.querySelectorAll('.sync-status');
            let html;
            if (!navigator.onLine) {
                html = `<i class="fas fa-cloud offline"></i> <span>غير متصل</span>`;
            } else if (isSyncing) {
                html = `<i class="fas fa-sync-alt fa-spin"></i> <span>جاري المزامنة...</span>`;
            } else if (getOfflineQueue().length > 0) {
                html = `<i class="fas fa-cloud-upload-alt"></i> <span>${getOfflineQueue().length} تحديثات بالانتظار</span>`;
            } else {
                html = `<i class="fas fa-check-circle" style="color:var(--primary-color);"></i> <span>تمت المزامنة</span>`;
            }
            statusElements.forEach(el => el.innerHTML = html);
        }

        function initializeOfflineSync() {
            window.addEventListener('online', syncQueuedUpdates);
            window.addEventListener('offline', updateSyncStatusUI);
            setInterval(syncQueuedUpdates, 15000);
            syncQueuedUpdates();
        }

        let buildingsData = [], filteredData = [], dashboardFilteredData = [];
        let currentUserType = "", currentPage = 1, pageSize = 50, totalPages = 1;
        let dashboardCurrentPage = 1, dashboardPageSize = 100, dashboardTotalPages = 1;
        let searchTimeout, dashboardSearchTimeout;
        let governorates = [], cities = {}, sectors = {}, blocks = {};
        let proposedUpdates = [];
        
        function loadInitialData() {
            onValue(ref(database, '/buildings'), (snapshot) => {
                const data = snapshot.val();
                buildingsData = data ? Object.keys(data).map(key => ({ ...data[key], db_key: key })) : [];
                initFilterData();
                // FIX: Removed call to updateHomepageTaskCounts for performance.
                updateDashboardStats();
                refreshAllViews();
            });
        }
        
        function refreshAllViews() {
            const activePage = document.querySelector('.page.active');
            if (!activePage) return;
            if (activePage.id === 'main-page') renderCRNList();
            else if (activePage.id === 'dashboard-page') renderDashboard();
        }
        
        function initFilterData() {
            governorates = [...new Set(buildingsData.map(b => b.governorate))].filter(Boolean);
            cities = {}; sectors = {}; blocks = {};
            governorates.forEach(gov => {
                cities[gov] = [...new Set(buildingsData.filter(b => b.governorate === gov).map(b => b.city))].filter(Boolean);
                cities[gov].forEach(city => {
                    const key = `${gov}-${city}`;
                    sectors[key] = [...new Set(buildingsData.filter(b => b.governorate === gov && b.city === city).map(b => b.sector))].filter(Boolean);
                    sectors[key].forEach(sector => {
                        blocks[`${key}-${sector}`] = [...new Set(buildingsData.filter(b => b.governorate === gov && b.city === city && b.sector === sector).map(b => b.block))].filter(Boolean);
                    });
                });
            });
            populateSelect('governorate-filter', governorates);
            populateSelect('dashboard-governorate', governorates);
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;
            const firstOption = select.querySelector('option[value=""]');
            select.innerHTML = `<option value="">${firstOption ? firstOption.textContent : "الكل"}</option>`;
            options.sort().forEach(opt => select.appendChild(new Option(opt, opt)));
        }

        function applyCRNFilters() {
            let data = buildingsData;
            if (currentUserType === 'office') data = data.filter(b => !b.map_confirmed && (!b.needs_field_visit || b.site_confirmed));
            else if (currentUserType === 'field') data = data.filter(b => b.needs_field_visit && !b.site_confirmed && !b.site_issue_reported);
            const gov = document.getElementById('governorate-filter').value, city = document.getElementById('city-filter').value, sector = document.getElementById('sector-filter').value, block = document.getElementById('block-filter').value, term = document.getElementById('search-box').value.toLowerCase();
            if (gov) data = data.filter(b => b.governorate === gov);
            if (city) data = data.filter(b => b.city === city);
            if (sector) data = data.filter(b => b.sector === sector);
            if (block) data = data.filter(b => b.block === block);
            if (term) data = data.filter(b => (b.crn && b.crn.toString().toLowerCase().includes(term)) || (b.governorate && b.governorate.toLowerCase().includes(term)) || (b.city && b.city.toLowerCase().includes(term)));
            return data;
        }

        function renderCRNList() {
            filteredData = applyCRNFilters();
            const pageSizeSelector = document.getElementById('page-size');
            pageSize = pageSizeSelector.value === 'all' ? filteredData.length : parseInt(pageSizeSelector.value, 10) || 50;
            totalPages = Math.ceil(filteredData.length / pageSize) || 1;
            currentPage = Math.min(currentPage, totalPages);
            const pageData = filteredData.slice((currentPage - 1) * pageSize, currentPage * pageSize);
            document.getElementById('results-count').textContent = `النتائج: ${filteredData.length}`;
            updatePaginationControls('main');
            const listEl = document.getElementById('crn-list');
            listEl.innerHTML = pageData.length === 0 ? `<div class="card" style="text-align:center; color: var(--muted-text);">لا توجد مهام حالياً.</div>` : pageData.map(generateCRNItemHTML).join('');
        }

        function generateCRNItemHTML(b) {
            let statusBadge = '';
            if (b.site_issue_reported) { statusBadge = '<span class="status-badge status-danger"><i class="fas fa-exclamation-circle"></i> تم الإبلاغ عن مشكلة</span>';
            } else if (b.map_confirmed) { statusBadge = '<span class="status-badge status-map"><i class="fas fa-check-circle"></i> مكتمل</span>'; 
            } else if (b.site_confirmed) { statusBadge = '<span class="status-badge status-site"><i class="fas fa-user-check"></i> تم تأكيد الموقع</span>'; 
            } else if (b.needs_field_visit) { statusBadge = '<span class="status-badge status-field"><i class="fas fa-shipping-fast"></i> مرسل للموقع</span>'; 
            } else { statusBadge = '<span class="status-badge status-unknown"><i class="fas fa-hourglass-start"></i> بانتظار المكتب</span>'; }
            
            let actionsHTML = '';
            if (currentUserType === 'office' && !b.map_confirmed && !b.site_issue_reported) {
                actionsHTML = b.site_confirmed ? `<button class="btn btn-primary action-btn" onclick="confirmOnMap('${b.db_key}')"><i class="fas fa-map-marked-alt"></i> تأكيد نهائي على الخريطة</button>`
                    : `<button class="btn btn-primary action-btn" onclick="confirmOnMap('${b.db_key}')"><i class="fas fa-map-marked-alt"></i> تأكيد على الخريطة</button><button class="btn btn-secondary action-btn" onclick="sendToField('${b.db_key}')"><i class="fas fa-route"></i> إرسال للموقع</button>`;
            } else if (currentUserType === 'field' && b.needs_field_visit && !b.site_confirmed && !b.site_issue_reported) {
                actionsHTML = `<button class="btn btn-primary action-btn" onclick="confirmSiteVisit('${b.db_key}')"><i class="fas fa-check"></i> تأكيد الزيارة الميدانية</button>
                               <button class="btn btn-danger action-btn" onclick="openDetailsModal('${b.db_key}')"><i class="fas fa-exclamation-triangle"></i> الإبلاغ عن مشكلة</button>`;
            }
            
            const queue = getOfflineQueue();
            const isPending = queue.some(item => item.data[`/buildings/${b.db_key}`]);
            const pendingClass = isPending ? 'pending-sync' : '';

            return `<div class="crn-item ${pendingClass}" data-db-key="${b.db_key}"><div class="crn-header"><span class="crn-id">${b.crn}</span>${statusBadge}</div><div class="crn-details"><div class="detail-item"><div class="detail-label"><i class="fas fa-globe-africa"></i> المحافظة</div><div>${b.governorate || 'N/A'}</div></div><div class="detail-item"><div class="detail-label"><i class="fas fa-city"></i> المدينة</div><div>${b.city || 'N/A'}</div></div><div class="detail-item"><div class="detail-label"><i class="fas fa-th-large"></i> القطاع</div><div>${b.sector || 'N/A'}</div></div><div class="detail-item"><div class="detail-label"><i class="fas fa-landmark"></i> البلوك</div><div>${b.block || 'N/A'}</div></div></div>${actionsHTML ? `<div class="actions">${actionsHTML}</div>` : ''}</div>`;
        }
        
        function applyDashboardFilters() {
            let data = buildingsData;
            const gov = document.getElementById('dashboard-governorate').value, city = document.getElementById('dashboard-city').value, sector = document.getElementById('dashboard-sector').value, block = document.getElementById('dashboard-block').value, status = document.getElementById('dashboard-status-filter').value, term = document.getElementById('dashboard-search').value.toLowerCase();
            if (gov) data = data.filter(b => b.governorate === gov);
            if (city) data = data.filter(b => b.city === city);
            if (sector) data = data.filter(b => b.sector === sector);
            if (block) data = data.filter(b => b.block === block);
            if (status) {
                if (status === 'needs-office-action') data = data.filter(b => !b.map_confirmed && !b.needs_field_visit && !b.site_confirmed && !b.site_issue_reported);
                else if (status === 'needs-field-visit') data = data.filter(b => b.needs_field_visit && !b.site_confirmed && !b.site_issue_reported);
                else if (status === 'field-confirmed') data = data.filter(b => b.site_confirmed && !b.map_confirmed);
                else if (status === 'map-confirmed') data = data.filter(b => b.map_confirmed);
                else if (status === 'site-issue-reported') data = data.filter(b => b.site_issue_reported);
            }
            if (term) data = data.filter(b => (b.crn && b.crn.toString().toLowerCase().includes(term)) || (b.governorate && b.governorate.toLowerCase().includes(term)) || (b.city && b.city.toLowerCase().includes(term)));
            return data;
        }

        function renderDashboard() {
            updateDashboardStats();
            dashboardFilteredData = applyDashboardFilters();
            const pageSizeSelector = document.getElementById('dashboard-page-size');
            dashboardPageSize = pageSizeSelector.value === 'all' ? dashboardFilteredData.length : parseInt(pageSizeSelector.value, 10) || 100;
            dashboardTotalPages = Math.ceil(dashboardFilteredData.length / dashboardPageSize) || 1;
            dashboardCurrentPage = Math.min(dashboardCurrentPage, dashboardTotalPages);
            const pageData = dashboardFilteredData.slice((dashboardCurrentPage - 1) * dashboardPageSize, dashboardCurrentPage * dashboardPageSize);
            document.getElementById('dashboard-results-count').textContent = `النتائج: ${dashboardFilteredData.length}`;
            updatePaginationControls('dashboard');
            const tableBody = document.querySelector("#buildings-table tbody"), noDataEl = document.getElementById('dashboard-no-data');
            tableBody.innerHTML = '';
            noDataEl.style.display = pageData.length === 0 ? 'block' : 'none';
            const fragment = document.createDocumentFragment();
            pageData.forEach(b => {
                const row = document.createElement('tr');
                let statusText = 'تحتاج إجراء مكتبي';
                if (b.site_issue_reported) { statusText = `مشكلة: ${b.site_issue_details || 'تفاصيل غير مسجلة'}`; row.classList.add('issue-row'); }
                else if (b.map_confirmed) { statusText = 'مكتمل'; row.classList.add('completed-row'); }
                else if (b.site_confirmed) { statusText = 'تم تأكيد الموقع'; }
                else if (b.needs_field_visit) { statusText = 'تحتاج زيارة ميدانية'; }
                row.innerHTML = `<td>${b.crn}</td><td>${b.governorate || ''}</td><td>${b.city || ''}</td><td>${b.sector || ''}</td><td>${b.block || ''}</td><td>${statusText}</td>
                                 <td><button class="btn btn-sm btn-outline" onclick="resetBuildingStatus('${b.db_key}', '${b.crn}')"><i class="fas fa-undo"></i> إعادة تعيين</button></td>`;
                fragment.appendChild(row);
            });
            tableBody.appendChild(fragment);
        }
        
        function updatePaginationControls(view) {
            const prefix = view === 'main' ? '' : 'dashboard-';
            const pageInfo = document.getElementById(`${prefix}page-info`), prevBtn = document.getElementById(`${prefix}prev-btn`), nextBtn = document.getElementById(`${prefix}next-btn`);
            const current = view === 'main' ? currentPage : dashboardCurrentPage, total = view === 'main' ? totalPages : dashboardTotalPages;
            if (pageInfo) pageInfo.textContent = `صفحة ${current || 1} من ${total || 1}`;
            if (prevBtn) prevBtn.disabled = current <= 1;
            if (nextBtn) nextBtn.disabled = current >= total;
        }
        
        window.showPage = (pageId, userType = "") => { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active'); if(userType) currentUserType = userType; if (pageId === 'main-page') { document.getElementById('user-type-label').textContent = userType === 'office' ? 'المطلوب من المكتب' : 'المطلوب من الموقع'; currentPage = 1; renderCRNList(); } else if (pageId === 'dashboard-page') { dashboardCurrentPage = 1; renderDashboard(); } };
        window.updateCityFilter = () => { const gov = document.getElementById('governorate-filter').value; populateSelect('city-filter', gov ? cities[gov] || [] : []); window.updateSectorFilter(); };
        window.updateDashboardCityFilter = () => { const gov = document.getElementById('dashboard-governorate').value; populateSelect('dashboard-city', gov ? cities[gov] || [] : []); window.updateDashboardSectorFilter(); };
        window.updateSectorFilter = () => { const gov = document.getElementById('governorate-filter').value, city = document.getElementById('city-filter').value; populateSelect('sector-filter', (gov && city && sectors[`${gov}-${city}`]) || []); window.updateBlockFilter(); };
        window.updateDashboardSectorFilter = () => { const gov = document.getElementById('dashboard-governorate').value, city = document.getElementById('dashboard-city').value; populateSelect('dashboard-sector', (gov && city && sectors[`${gov}-${city}`]) || []); window.updateDashboardBlockFilter(); };
        window.updateBlockFilter = () => { const gov = document.getElementById('governorate-filter').value, city = document.getElementById('city-filter').value, sec = document.getElementById('sector-filter').value; populateSelect('block-filter', (gov && city && sec && blocks[`${gov}-${city}-${sec}`]) || []); renderCRNList(); };
        window.updateDashboardBlockFilter = () => { const gov = document.getElementById('dashboard-governorate').value, city = document.getElementById('dashboard-city').value, sec = document.getElementById('dashboard-sector').value; populateSelect('dashboard-block', (gov && city && sec && blocks[`${gov}-${city}-${sec}`]) || []); renderDashboard(); };
        window.debounceSearch = () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { currentPage = 1; renderCRNList(); }, 300); };
        window.debounceDashboardSearch = () => { clearTimeout(dashboardSearchTimeout); dashboardSearchTimeout = setTimeout(() => { dashboardCurrentPage = 1; renderDashboard(); }, 300); };
        window.nextPage = () => { if (currentPage < totalPages) { currentPage++; renderCRNList(); } };
        window.previousPage = () => { if (currentPage > 1) { currentPage--; renderCRNList(); } };
        window.changePageSize = () => { currentPage = 1; renderCRNList(); };
        window.nextDashboardPage = () => { if (dashboardCurrentPage < dashboardTotalPages) { dashboardCurrentPage++; renderDashboard(); } };
        window.previousDashboardPage = () => { if (dashboardCurrentPage > 1) { dashboardCurrentPage--; renderDashboard(); } };
        window.changeDashboardPageSize = () => { dashboardCurrentPage = 1; renderDashboard(); };

        window.confirmOnMap = db_key => queueUpdate(db_key, { map_confirmed: true, map_timestamp: new Date().toISOString() });
        window.sendToField = db_key => queueUpdate(db_key, { needs_field_visit: true });
        window.confirmSiteVisit = db_key => queueUpdate(db_key, { site_confirmed: true, site_timestamp: new Date().toISOString() });

        // FIX: Removed the homepage task count function entirely.

        window.updateDashboardStats = () => { const el = id => document.getElementById(id); if(el('stat-total')) el('stat-total').textContent = buildingsData.length; if(el('stat-completed')) el('stat-completed').textContent = buildingsData.filter(b => b.map_confirmed).length; if(el('stat-at-field')) el('stat-at-field').textContent = buildingsData.filter(b => b.needs_field_visit && !b.site_confirmed && !b.site_issue_reported).length; if(el('stat-at-office')) el('stat-at-office').textContent = buildingsData.filter(b => !b.map_confirmed && (!b.needs_field_visit || b.site_confirmed) && !b.site_issue_reported).length; };
        
        window.submitProblemDetails = () => {
            const db_key = document.getElementById('modal-db-key-input').value, details = document.getElementById('problem-details-input').value;
            if (!db_key || !details.trim()) { alert("الرجاء كتابة تفاصيل المشكلة."); return; }
            queueUpdate(db_key, { site_issue_reported: true, site_issue_details: details, site_issue_timestamp: new Date().toISOString() });
            closeDetailsModal();
        };

        window.resetBuildingStatus = (db_key, crn) => {
            if (!confirm(`هل أنت متأكد من إعادة تعيين حالة المبنى ${crn}؟\nسيؤدي هذا إلى إزالة جميع التأكيدات (الموقع والخريطة) وإرجاع المهمة إلى المكتب.`)) return;
            const updates = { needs_field_visit: null, site_confirmed: null, map_confirmed: null, site_issue_reported: null, site_issue_details: null, site_timestamp: null, map_timestamp: null, site_issue_timestamp: null };
            update(ref(database, `/buildings/${db_key}`), updates).then(() => {
                alert(`تمت إعادة تعيين حالة المبنى ${crn} بنجاح.`);
            }).catch(e => alert(`فشل إعادة التعيين: ${e.message}`));
        };

        window.openDetailsModal = db_key => { document.getElementById('modal-db-key-input').value = db_key; document.getElementById('details-modal').style.display = 'flex'; };
        window.closeDetailsModal = () => { document.getElementById('details-modal').style.display = 'none'; document.getElementById('problem-details-input').value = ''; document.getElementById('modal-db-key-input').value = ''; };

        window.handleNewDataUpload = event => {
            const file = event.target.files[0]; if (!file) return;
            document.getElementById('loading-overlay').style.display = 'flex';
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    if (jsonData.length === 0) throw new Error('الملف فارغ.');
                    if (!jsonData[0].crn) throw new Error('الملف يجب أن يحتوي على عمود "crn".');
                    const updates = {}, allCrns = new Set(buildingsData.map(b => b.crn.toString()));
                    for (const row of jsonData) {
                        const crn = row.crn ? row.crn.toString() : null;
                        if (!crn || allCrns.has(crn)) continue;
                        const newKey = push(ref(database, '/buildings')).key;
                        if (newKey) updates[`/buildings/${newKey}`] = row;
                    }
                    const count = Object.keys(updates).length;
                    if (count > 0) {
                        if (confirm(`تم العثور على ${count} سجل جديد. هل تريد إضافتها؟`)) {
                            update(ref(database), updates).then(() => alert(`تمت إضافة ${count} سجل بنجاح.`));
                        } else alert("تم إلغاء الإضافة.");
                    } else alert("لم يتم العثور على سجلات جديدة (قد تكون كل السجلات موجودة بالفعل).");
                } catch (error) { alert(`خطأ في معالجة الملف: ${error.message}`); } finally { document.getElementById('loading-overlay').style.display = 'none'; event.target.value = ''; }
            };
            reader.readAsArrayBuffer(file);
        };
        window.handleStatusUpdateUpload = event => {
            const file = event.target.files[0]; if (!file) return;
            document.getElementById('loading-overlay').style.display = 'flex';
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    if (jsonData.length === 0) throw new Error('الملف فارغ.');
                    if (!jsonData[0].crn) throw new Error('الملف يجب أن يحتوي على عمود "crn" للمطابقة.');
                    const crnMap = new Map(buildingsData.map(b => [b.crn.toString(), b.db_key]));
                    proposedUpdates = [];
                    const notFoundCrns = [];
                    const validUpdateCols = ['needs_field_visit', 'site_confirmed', 'map_confirmed', 'site_issue_reported', 'site_issue_details'];
                    for (const row of jsonData) {
                        const crn = row.crn ? row.crn.toString() : null;
                        if (!crn) continue;
                        if (crnMap.has(crn)) {
                            const db_key = crnMap.get(crn);
                            const updateData = {};
                            let hasUpdate = false;
                            for (const col of validUpdateCols) {
                                if (row[col] !== undefined) {
                                    hasUpdate = true;
                                    if (typeof row[col] === 'boolean') { updateData[col] = row[col];
                                    } else if (typeof row[col] === 'string') { updateData[col] = /true|نعم|1/i.test(row[col]);
                                    } else { updateData[col] = row[col]; }
                                }
                            }
                            if (hasUpdate) proposedUpdates.push({ db_key, updateData });
                        } else notFoundCrns.push(crn);
                    }
                    showUpdatePreviewModal(proposedUpdates.length, notFoundCrns);
                } catch (error) { alert(`خطأ في معالجة الملف: ${error.message}`);
                } finally { document.getElementById('loading-overlay').style.display = 'none'; event.target.value = ''; }
            };
            reader.readAsArrayBuffer(file);
        };
        window.showUpdatePreviewModal = (foundCount, notFound) => {
            const summaryEl = document.getElementById('update-preview-summary');
            let summaryHTML = `<p class="success"><i class="fas fa-check-circle"></i> تم العثور على <strong>${foundCount}</strong> سجل لتحديث حالتهم.</p>`;
            if (notFound.length > 0) {
                summaryHTML += `<p class="warning"><i class="fas fa-exclamation-triangle"></i> لم يتم العثور على <strong>${notFound.length}</strong> أرقام CRN في قاعدة البيانات: ${notFound.slice(0, 5).join(', ')}...</p>`;
            }
            summaryEl.innerHTML = summaryHTML;
            document.getElementById('update-preview-modal').style.display = 'flex';
        };
        window.closeUpdatePreviewModal = () => { document.getElementById('update-preview-modal').style.display = 'none'; proposedUpdates = []; };
        window.confirmUpdates = () => {
            if (proposedUpdates.length === 0) { alert("لا توجد تحديثات لتنفيذها."); closeUpdatePreviewModal(); return; }
            document.getElementById('loading-overlay').style.display = 'flex';
            const finalUpdates = {};
            proposedUpdates.forEach(item => {
                const currentData = buildingsData.find(b => b.db_key === item.db_key) || {};
                finalUpdates[`/buildings/${item.db_key}`] = { ...currentData, ...item.updateData };
            });
            update(ref(database), finalUpdates).then(() => {
                alert(`تم تحديث ${proposedUpdates.length} سجل بنجاح.`);
            }).catch(e => {
                alert(`فشل التحديث: ${e.message}`);
            }).finally(() => {
                document.getElementById('loading-overlay').style.display = 'none';
                closeUpdatePreviewModal();
            });
        };
        window.handleDeleteFilteredData = () => {
            if (dashboardFilteredData.length === 0) { alert("يرجى تحديد البيانات المراد حذفها باستخدام الفلاتر أولاً."); return; }
            if (!confirm(`هل أنت متأكد من حذف ${dashboardFilteredData.length} سجل/سجلات المحددة نهائياً؟`)) return;
            document.getElementById('loading-overlay').style.display = 'flex';
            const updates = {};
            dashboardFilteredData.forEach(r => { updates['/buildings/' + r.db_key] = null; });
            update(ref(database), updates).then(() => {
                alert(`تم حذف ${dashboardFilteredData.length} سجل بنجاح.`);
            }).catch(e => { alert(`فشل الحذف: ${e.message}`); }).finally(() => document.getElementById('loading-overlay').style.display = 'none');
        };
        window.exportCurrentView = () => {
            let dataToExport = [];
            const activePage = document.querySelector('.page.active');
            if (activePage.id === 'main-page') dataToExport = filteredData;
            else if (activePage.id === 'dashboard-page') dataToExport = dashboardFilteredData;
            if (dataToExport.length === 0) { alert("لا توجد بيانات لتصديرها."); return; }
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Data");
            XLSX.writeFile(workbook, "GasCRN_Export.xlsx");
        };
        window.resetDashboardFilters = () => { ['dashboard-search', 'dashboard-governorate', 'dashboard-status-filter'].forEach(id => document.getElementById(id).value = ""); window.updateDashboardCityFilter(); dashboardCurrentPage = 1; renderDashboard(); };
    </script>
</body>
</html>
